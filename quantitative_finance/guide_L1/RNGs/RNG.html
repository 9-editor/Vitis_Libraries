

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Random Number Generator &mdash; Vitis Quantitative Finance Library 1.0 pre-alpha documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/xilinx-favicon.ico"/>
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Singular Value Decomposition (SVD)" href="../SVD/SVD.html" />
    <link rel="prev" title="L1 Module User Guide" href="../L1.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Vitis Quantitative Finance Library
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Library Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html#license">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html#trademark-notice">Trademark Notice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rel.html">Release Note</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../models_and_methods.html">Pricing Models and Numerical Methods</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../L1.html">L1 Module User Guide</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../L1.html#core-utility">Core Utility</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Random Number Generator</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#uniform-distributed-random-number-generator">Uniform Distributed Random Number Generator</a></li>
<li class="toctree-l4"><a class="reference internal" href="#normal-distributed-random-number-generator-nrng">Normal Distributed Random Number Generator(NRNG)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../SVD/SVD.html">Singular Value Decomposition (SVD)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../TRSV/TRSV.html">Tridiagonal Matrix Solver</a></li>
<li class="toctree-l3"><a class="reference internal" href="../Pentadiag/Pentadiag.html">Pentadiagonal Matrix Solver</a></li>
<li class="toctree-l3"><a class="reference internal" href="../SobolRsg/sobolrsg.html">Sobol Sequence Generator</a></li>
<li class="toctree-l3"><a class="reference internal" href="../brownian/bb.html">Brownian Bridge Transform</a></li>
<li class="toctree-l3"><a class="reference internal" href="../StochasticProcess/stochastic_process1d.html">StochasticProcess1D</a></li>
<li class="toctree-l3"><a class="reference internal" href="../StochasticProcess/ornsteinuhlenbeck_process.html">OrnsteinUhlenbeckProcess</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fdmmesher/fdmmesher.html">Meshers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../L1.html#l1-module-apis">L1 Module APIs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../guide_L2/L2.html">L2 Pricing Engine Kernel User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide_L3/L3.html">L3 Overlay User Guide</a></li>
</ul>
<p class="caption"><span class="caption-text">Benchmark Result</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../benchmark/benchmark.html">Quality and Performance</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Vitis Quantitative Finance Library</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../L1.html">L1 Module User Guide</a> &raquo;</li>
        
      <li>Random Number Generator</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/guide_L1/RNGs/RNG.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="random-number-generator">
<h1>Random Number Generator<a class="headerlink" href="#random-number-generator" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p><cite>Random Number Generator</cite> (RNG) is one of the core utilities needed by Monte Carlo Simulation.
We provide RNGs that generate uniform distribution and normal distribution. The detailed supported RNGs are listed below.</p>
<table border="1" class="docutils">
<colgroup>
<col width="28%" />
<col width="31%" />
<col width="17%" />
<col width="24%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">RNG name</th>
<th class="head">Distribution generated</th>
<th class="head">DataType supported</th>
<th class="head">Underlying Algorithm</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>MT19937</td>
<td>Uniform Distribution in (0,1)</td>
<td>float, double</td>
<td>Mersenne Twister (MT19937)</td>
</tr>
<tr class="row-odd"><td>MT2203</td>
<td>Uniform Distribution in (0,1)</td>
<td>float, double</td>
<td>Mersenne Twister (MT2203)</td>
</tr>
<tr class="row-even"><td>MT19937IcnRng</td>
<td>Normal Distribution N(0,1)</td>
<td>float, double</td>
<td>Inverse CDF Transformation</td>
</tr>
<tr class="row-odd"><td>MT2203IcnRng</td>
<td>Normal Distribution N(0,1)</td>
<td>float, double</td>
<td>Inverse CDF Transformation</td>
</tr>
<tr class="row-even"><td>MT19937BoxMullerNomralRng</td>
<td>Normal Distribution N(0,1)</td>
<td>float, double</td>
<td>Box Muller Transformation</td>
</tr>
<tr class="row-odd"><td>MultiVariateNormalRng</td>
<td>Multi Variate Normal Distribution</td>
<td>float, double</td>
<td>Cholesky Decomposition</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="uniform-distributed-random-number-generator">
<h2>Uniform Distributed Random Number Generator<a class="headerlink" href="#uniform-distributed-random-number-generator" title="Permalink to this headline">¶</a></h2>
<p>Uniform Distributed Random Number Generator is the foundation of all RNGs.
In this implementation, we use the Mersenne Twister Algorithm (MT19937 and MT2203) as the underlying algorithm.</p>
<p>Reference: Mersenne Twister: A 623-Dimensionally Equidistributed Uniform Pseudo-Random Number Generator.</p>
<div class="section" id="algorithm">
<h3>Algorithm<a class="headerlink" href="#algorithm" title="Permalink to this headline">¶</a></h3>
<p>The basic element of Mersenne Twister(MT) Algorithm is vector, a <span class="math notranslate nohighlight">\(w\)</span> bits unsigned integer.
The MT Algorithm generates a sequence of vectors, which are considered to be uniform distributed in <span class="math notranslate nohighlight">\((0, 2^w - 1)\)</span>.
These vectors could be mapped to (0,1) after dividing by <span class="math notranslate nohighlight">\(2^w\)</span>.</p>
<p>The basic algorithm is composed of two parts. First part is iterative with the formula below</p>
<div class="math notranslate nohighlight">
\[X_{k + n} = X_{k + m} \bigoplus (X_{k}^u|X_{k+1}^l)A\]</div>
<a class="reference internal image-reference" href="../../_images/iteration_formula.png"><img alt="Diagram of MCEuropeanHestonEngine" class="align-center" src="../../_images/iteration_formula.png" style="width: 80%;" /></a>
<p>Where <span class="math notranslate nohighlight">\(X_{k + n}\)</span> denotes the <span class="math notranslate nohighlight">\(k\)</span>, <span class="math notranslate nohighlight">\(X_1\)</span>,…, <span class="math notranslate nohighlight">\(X_{n - 1}\)</span> as initial vectors.
<span class="math notranslate nohighlight">\(X_{k}^u\)</span> means the upper <span class="math notranslate nohighlight">\(w - r\)</span> bits of <span class="math notranslate nohighlight">\(X_{k}\)</span>, <span class="math notranslate nohighlight">\(X_{k + 1}^u\)</span> means the lower <span class="math notranslate nohighlight">\(r\)</span> bits of <span class="math notranslate nohighlight">\(X_{k + 1}\)</span>.
<span class="math notranslate nohighlight">\((X_{k}^u|X_{k+1}^l)\)</span> is just combination of upper <span class="math notranslate nohighlight">\(w - r\)</span> bits of <span class="math notranslate nohighlight">\(X_{k}\)</span> and lower <span class="math notranslate nohighlight">\(r\)</span> bits of <span class="math notranslate nohighlight">\(X_{k + 1}\)</span>.
<span class="math notranslate nohighlight">\(\bigoplus\)</span> is bitwise addition. The multiplication of <span class="math notranslate nohighlight">\(A\)</span> could be done by bits operations:</p>
<div class="math notranslate nohighlight">
\[XA = shiftright(X) \:\:\: if X[0] = 0\]</div>
<div class="math notranslate nohighlight">
\[XA = shiftright(X)\bigoplus a \:\:\: if X[0] = 1\]</div>
<p>Where <span class="math notranslate nohighlight">\(a\)</span> is a constant vector.</p>
<p>The second part is tempering, which consists of four steps below.</p>
<div class="math notranslate nohighlight">
\[Y = X \bigoplus (X &gt;&gt; u)\]</div>
<div class="math notranslate nohighlight">
\[Y = Y \bigoplus ((Y &lt;&lt; s) \:\: AND \:\: b )\]</div>
<div class="math notranslate nohighlight">
\[Y = Y \bigoplus ((Y &lt;&lt; t) \:\: AND \:\: c )\]</div>
<div class="math notranslate nohighlight">
\[Z = Y \bigoplus (Y &gt;&gt; l)\]</div>
<p>Where <span class="math notranslate nohighlight">\(u\)</span>, <span class="math notranslate nohighlight">\(s\)</span>, <span class="math notranslate nohighlight">\(t\)</span>, and <span class="math notranslate nohighlight">\(l\)</span> are constant parameters indicate shift length, <span class="math notranslate nohighlight">\(b\)</span> and <span class="math notranslate nohighlight">\(c\)</span> are two const vectors.</p>
<p>A combination of <span class="math notranslate nohighlight">\(w\)</span>, <span class="math notranslate nohighlight">\(n\)</span>, <span class="math notranslate nohighlight">\(r\)</span>, <span class="math notranslate nohighlight">\(m\)</span>, <span class="math notranslate nohighlight">\(u\)</span>, <span class="math notranslate nohighlight">\(s\)</span>, <span class="math notranslate nohighlight">\(t\)</span>, <span class="math notranslate nohighlight">\(l\)</span>, <span class="math notranslate nohighlight">\(a\)</span>, <span class="math notranslate nohighlight">\(b\)</span>, <span class="math notranslate nohighlight">\(c\)</span> determines a variation of Mersenne Twister.
Only a limited combination could work.</p>
</div>
<div class="section" id="implementation-details">
<h3>Implementation Details<a class="headerlink" href="#implementation-details" title="Permalink to this headline">¶</a></h3>
<p>The optimization happens in the first part.
We don’t store all history of vectors generated, only the last <span class="math notranslate nohighlight">\(n\)</span> vectors.
We use a circular queue in BRAMs to store these values.
Depth of BRAM is set to be least 2’s power that larger than n.
This will make the calculation of the address simpler.
By keeping and updating the address of the starting vector, we can always calculate the address of vectors we need to access.</p>
<a class="reference internal image-reference" href="../../_images/circular_queue.png"><img alt="Circular Queue of vectors" class="align-center" src="../../_images/circular_queue.png" style="width: 80%;" /></a>
<p>To generate k-th vector, we need 3 read ops, for <span class="math notranslate nohighlight">\(X_{k}\)</span>, <span class="math notranslate nohighlight">\(X_{k + 1}\)</span> and <span class="math notranslate nohighlight">\(X_{k + m}\)</span>.
In the next iteration, we need to read <span class="math notranslate nohighlight">\(X_{k + 1}\)</span>, <span class="math notranslate nohighlight">\(X_{k + 2}\)</span> and <span class="math notranslate nohighlight">\(X_{k + m + 1}\)</span>.
This means we only need to read <span class="math notranslate nohighlight">\(X_{k + 2}\)</span> and <span class="math notranslate nohighlight">\(X_{k + m + 1}\)</span>, since we could save <span class="math notranslate nohighlight">\(X_{k + 1}\)</span> as buffer.
So, we need 2 read accesses at different vectors and 1 write access for generating the new vector.
Since BRAM only allows 2 read or write accesses at a single cycle, it’s not able to generate the new vector at each.
In the implementation, we copy the identical vectors to different BRAMs, and each of them provides sufficient read or write access.</p>
<a class="reference internal image-reference" href="../../_images/dup_queue.png"><img alt="Duplicated vectors." class="align-center" src="../../_images/dup_queue.png" style="width: 80%;" /></a>
</div>
</div>
<div class="section" id="normal-distributed-random-number-generator-nrng">
<h2>Normal Distributed Random Number Generator(NRNG)<a class="headerlink" href="#normal-distributed-random-number-generator-nrng" title="Permalink to this headline">¶</a></h2>
<p>NRNG is the most useful RNG in Monte Carlo Simulation.
We provide two kinds of NRNG, Inverse Cumulative Distributed Function based and Box-Muller transformation based.</p>
<div class="section" id="inverse-cumulative-distribution-transformation-based-rng">
<h3>Inverse cumulative distribution transformation based RNG<a class="headerlink" href="#inverse-cumulative-distribution-transformation-based-rng" title="Permalink to this headline">¶</a></h3>
<p>For a certain distribution of random variable <span class="math notranslate nohighlight">\(Z\)</span>, it has a corresponding cumulative distribution function <span class="math notranslate nohighlight">\(\Psi(x)\)</span>.
This function measures the probability that <span class="math notranslate nohighlight">\(Z &lt; x\)</span>.
Since <span class="math notranslate nohighlight">\(\Psi(x)\)</span> is monotonically increasing function, it has an inverse function <span class="math notranslate nohighlight">\(\Psi^{-1}(x)\)</span>.
It is mathematically approved that for uniform-distributed random variable <span class="math notranslate nohighlight">\(U\)</span> in range (0, 1),
<span class="math notranslate nohighlight">\(\Psi^{-1}(U)\)</span> is also a random variable and its cumulative distribution function is <span class="math notranslate nohighlight">\(\Psi(x)\)</span>.</p>
<p>We have two versions of Inverse Cumulative Distribution Function (ICDF) with the data type of float or double, details of algorithms could be found from reference papers.
Both of them use fractional polynomial approximation method.
They both have two branches for value from different input range and they share similar logics.
To save DSPs, we combined the two branches and manually binding calculation to the same hardware resource to get the same performance and accuracy.
Take ICDF with float data type as an example, the basic approximation formula is (main fractional polynomial approximation part, not all) as below:</p>
<div class="math notranslate nohighlight">
\[y = \frac {(((a_3 x) + a_2)x + a_1) + a_0}{((b_3 x) + b_2)x + b_1}   \:\:\:\: if x &lt; x_{lower} \:\:or\:\: x &gt; x_{upper}\]</div>
<div class="math notranslate nohighlight">
\[y = \frac {((c_2 x) + c_1)x + c_0}{(d_2 x) + d_1}   \:\:\:\: if \:x_{lower}&lt; x &lt; x_{upper}\]</div>
<p>Although these two conditions have different formulas, they can merge into one formula with parameters configured by which range that <span class="math notranslate nohighlight">\(x\)</span> belongs to.
As shown in the diagram below, if parameters took the value at left, it would become the first formula above. If at right, it would become the second formula above.</p>
<a class="reference internal image-reference" href="../../_images/combine_branch.png"><img alt="Combine branch" class="align-center" src="../../_images/combine_branch.png" style="width: 80%;" /></a>
<p>Reference:
Algorithm AS 241, The Percentage Points of the Normal Distribution by  Michael J. Wichura.
Acklam’s approximation: by Peter J. Acklam, University of Oslo, Statistics Division.</p>
</div>
<div class="section" id="box-muller-transformation-based-nrng">
<h3>Box-Muller transformation based NRNG<a class="headerlink" href="#box-muller-transformation-based-nrng" title="Permalink to this headline">¶</a></h3>
<p>Box-Muller transformation takes two uniformed distributed random numbers to generate two normal-distributed random number.
Although it is an efficient method, it could not hold certain algebra characteristics of input uniformed distributed random number serials,
especially when we need NRNG in low-discrepancy serials.
It’s not the first choice of NRNG in the current stage.</p>
<div class="math notranslate nohighlight">
\[Z_0 = \sqrt[2]{-2\ln{U_1}}\cos{2\pi U_2}\]</div>
<div class="math notranslate nohighlight">
\[Z_1 = \sqrt[2]{-2\ln{U_1}}\sin{2\pi U_2}\]</div>
<p>To smooth output, Box-Muller implementation takes 1 uniformed random number at each call of next(),
outputs 1 normal distributed random number which is already generated and cache.
When 2 inputs have been cached, it performs Box-Muller transformation above and generates the next two normal-distributed random numbers.</p>
<a class="reference internal image-reference" href="../../_images/smooth_input_output.png"><img alt="Smooth input and ouput" class="align-center" src="../../_images/smooth_input_output.png" style="width: 80%;" /></a>
</div>
<div class="section" id="multi-variate-normal-distribution-rng">
<h3>Multi Variate Normal Distribution RNG<a class="headerlink" href="#multi-variate-normal-distribution-rng" title="Permalink to this headline">¶</a></h3>
<p>Multi-variate normal distribution RNG output N random variates. Each variate’s distribution is N(0, 1), and these variates have a certain correlation.
To generate such variates, this RNG needs to set up the lower triangle matrix first, which is the result of the Cholesky decomposition of the correlation matrix.
This implementation supports an even number of variate which is 2N. Instead of storing a 2N-by-2N matrix, we only store the N*(2N+1) non-zero elements.
The storage scheme is as below. This RNG needs to pre-calculate a certain number of random numbers before it can output the right random number.</p>
<a class="reference internal image-reference" href="../../_images/ltm_structure.png"><img alt="Storage of Lower Triangle Matrix" class="align-center" src="../../_images/ltm_structure.png" style="width: 80%;" /></a>
<p>Put the storage scheme aside, the basic working principle is using one underlying random number generator to produce several independent random numbers.
Every 2N independent random numbers compose a vector. By multiplying this vector with the lower triangle matrix, we get the result vector.
Elements of result vector are multi-variate normal distribution random numbers, which have the pre-set correlation.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../SVD/SVD.html" class="btn btn-neutral float-right" title="Singular Value Decomposition (SVD)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../L1.html" class="btn btn-neutral" title="L1 Module User Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Xilinx Inc.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>