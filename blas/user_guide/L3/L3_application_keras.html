

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="keywords" content="Vitis, library, Database, Quantitative Finance, Vision, Data Compression, Security, Solver, BLAS, Hardware, xfOpenCV, xfdatabase, xffintech, xfcompression, xfsecurity, xfsolver, xfblas, xfhardware"/>
<meta name="description" content="Vitis software development platform includes an extensive set of open-source, performance-optimized libraries that offer out-of-the-box acceleration with minimal to zero-code changes to your existing applications, without the need to reimplement your algorithms from scratch to harness the benefits of Xilinx adaptive compute."/>
<meta name="xlnxdocumentclass" content="Document"> 
<meta name="xlnxdocumenttypes" content="Tutorials"> 
<!-- Header information provided by Emily-->
    <meta name="Language" content="en">
    <meta name="Location" content="us">
    <link rel="icon" type="image/vnd.microsoft.icon" href="https://www.xilinx.com/etc.clientlibs/site/clientlibs/xilinx/all/resources/favicon.ico">
    <link rel="shortcut icon" type="image/vnd.microsoft.icon" href="https://www.xilinx.com/etc.clientlibs/site/clientlibs/xilinx/all/resources/favicon.ico">
  
  <title>XFBLAS L3 based Keras MLP Acceleration &mdash; Vitis BLAS Library 1.0 beta documentation</title>
  
<!-- Header information provided by Emily-->
    <meta name="apple-itunes-app" content="app-id=1063287962">
    <meta name="google-play-app" content="app-id=com.marketing.xilinxgo">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <script src="https://kit.fontawesome.com/d3dd8c60ed.js"></script>
    
    <link rel="stylesheet" href="https://www.xilinx.com/etc.clientlibs/clientlibs/granite/jquery-ui.min.css" type="text/css">
    <link rel="stylesheet" href="https://www.xilinx.com/etc.clientlibs/site/clientlibs/xilinx/header-footer.min.css" type="text/css">
    <link rel="stylesheet" href="https://www.xilinx.com/etc.clientlibs/site/clientlibs/xilinx/all.min.css" type="text/css">
    
    <script type="text/javascript" src="https://www.xilinx.com/etc.clientlibs/clientlibs/granite/jquery.min.js"></script>
    <script type="text/javascript" src="https://www.xilinx.com/etc.clientlibs/clientlibs/granite/jquery-ui.min.js"></script>
    <script type="text/javascript" src="https://www.xilinx.com/etc.clientlibs/site/clientlibs/xilinx/header-footer.min.js"></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet" type="text/css">
  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="prev" title="L3 API application" href="L3_application.html" /> 
</head>

<body class="wy-body-for-nav">
<div class="xilinx-bs3">
    <noindex>
        <header data-component="header">
            <nav class="navbar navbar-default">
                <div class="container main-nav">
                    <div class="row">
                        <div class="col-xs-5 col-sm-2 logo-column">
                            <div class="logo">
                                <a href="https://www.xilinx.com/">
                                    <img src="https://www.xilinx.com/etc.clientlibs/site/clientlibs/xilinx/all/resources/imgs/header/xilinx-header-logo.svg" title="Xilinx Inc" />
                                </a>
                            </div>
                        </div>
                        <div class="col-xs-12 col-sm-8 navbar-column">
                            <div class="navbar navbar-collapse collapse" id="xilinx-main-menu">
                                <ul class="nav navbar-nav nav-justified">
                                    <li class="accordion-toggle-icons" data-component="toggle-dropdown">
                                        <a href="https://developer.xilinx.com/">
                                            Developers
                                        </a>
                                    </li>
                                    <li class="accordion-toggle-icons" data-component="toggle-dropdown">
                                        <a href="https://www.xilinx.com/support.html">
                                            Support
                                        </a>
                                    </li>
                                    <li class="accordion-toggle-icons" data-component="toggle-dropdown">
                                        <a href="https://forums.xilinx.com/">
                                            Forums
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="mini-nav col-sm-2">
                            <button type="button" data-function="xilinx-mobile-menu" id="nav-toggle" class="navbar-toggle collapsed visible-xs-block" aria-expanded="false">
                                <span></span>
                                <span></span>
                                <span></span>
                                <span></span>
                            </button>
                        </div>
                    </div>
                </div>
            </nav>
        </header>
    </noindex>
</div>
   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Vitis BLAS Library
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Library Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html#license">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html#trademark-notice">Trademark Notice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release.html">Release Note</a></li>
</ul>
<p class="caption"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../L1/L1.html">L1 Primitives User Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="L3.html">L3 API User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="L3_overview.html">L3 API Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="L3_example.html">L3 API example</a></li>
<li class="toctree-l2"><a class="reference internal" href="L3_benchmark.html">L3 API benchmark</a></li>
<li class="toctree-l2"><a class="reference internal" href="L3_test.html">L3 API test</a></li>
<li class="toctree-l2"><a class="reference internal" href="L3_python_bindings.html">L3 Python bindings</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="L3_application.html">L3 API application</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">XFBLAS L3 based Keras MLP Acceleration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#introduction">1. Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#python-classes-for-using-keras">2. Python Classes for using Keras</a></li>
<li class="toctree-l4"><a class="reference internal" href="#steps-to-run-the-application">3. Steps to run the application</a></li>
<li class="toctree-l4"><a class="reference internal" href="#details">3. details</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

            
			<p class="caption"><span class="caption-text">This Page</span></p>
				<ul class="current">
				  <li class="toctree-l1"><a href="../../_sources/user_guide/L3/L3_application_keras.rst.txt"
						rel="nofollow">Show Source</a></li>						
				</ul>
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Vitis BLAS Library</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="L3.html">L3 API User Guide</a> &raquo;</li>
        
          <li><a href="L3_application.html">L3 API application</a> &raquo;</li>
        
      <li>XFBLAS L3 based Keras MLP Acceleration</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/user_guide/L3/L3_application_keras.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="xfblas-l3-based-keras-mlp-acceleration">
<span id="keras-application-l3"></span><h1>XFBLAS L3 based Keras MLP Acceleration<a class="headerlink" href="#xfblas-l3-based-keras-mlp-acceleration" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>1. Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Keras is Python based machine learning framework. It provides high level neural network APIs. It can run on top of other low level neural network frameworks for numerical computations. XFBLAS L3 Python APIs could be used for full connected Keras model and could provide better performance compared to CPU result.</p>
<p>In L3/applications/MLP/keras/simple, an example of using Keras to do classification on a simple model showed that how to use XFBLAS L3 Python APIs in Keras applications.</p>
</div>
<div class="section" id="python-classes-for-using-keras">
<h2>2. Python Classes for using Keras<a class="headerlink" href="#python-classes-for-using-keras" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="steps-to-run-the-application">
<h2>3. Steps to run the application<a class="headerlink" href="#steps-to-run-the-application" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Build shared library</p></li>
<li><p>set PYTHONPATH</p></li>
<li><p>find the path to the xclbin and run the command (currently U200 and U250 are supported, xclbin could be downloaded in <a class="reference external" href="https://www.xilinx.com/bin/public/openDownload?filename=vitis_BLAS_library_r1.0_xclbin.tar">Vitis BLAS library xclbins</a> )</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">source</span> /opt/xilinx/xrt/setup.sh
<span class="nb">cd</span> L3/src/sw/python_api/
make
<span class="nb">cd</span> ../../../applications/MLP/keras/simple/
<span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span>../../../../src/sw/python_api:./
python mlp.py --data data/SansEC_Train_Data.csv --model best_model.h5 --xclbin PATH_TO_FCN_XCLBIN/gemx.xclbin --cfg PATH_TO_FCN_XCLBIN/config_info.dat --lib ../../../../src/sw/python_api/lib/xfblas.so
</pre></div>
</div>
</div>
<div class="section" id="details">
<h2>3. details<a class="headerlink" href="#details" title="Permalink to this headline">¶</a></h2>
<p>This Keras application is using xclbin that included FCN (Fully Connected Network) engine. FCN engine is based on GEMM operation with post scales and pRelu supported.</p>
<ul class="simple">
<li><p>FCN :</p></li>
</ul>
<ol class="arabic simple">
<li><p>C = pRelu(((A * B + X) * alpha) &gt;&gt; beta; where A, B, X and C are dense matrices, alpha and beta are integers.</p></li>
<li><p>pRelu: for each c in C; c = (c &lt; 0)? ((c * pRelu_alpha) &gt;&gt; pRelu_beta): c; where pRelu_alpha and pRelu_beta are integers.</p></li>
</ol>
<p>The following two packages are required for using XFBLAS L3 Python APIs:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">xfblas_L3</span> <span class="k">as</span> <span class="nn">xfblas</span>
<span class="kn">import</span> <span class="nn">mlp_common</span>
</pre></div>
</div>
<p>Only predict is done by FPGA, so CPU pre-trained 3-layer model is saved in best_model.h5, users could also set option –train to True to re-train the model.</p>
<p>Option –run_async is for the case when xclbin has multiple compute units, users could set it to True to run those CUs in parallel. For larger input sizes, this will bring better performance compared to run one by one. Currently, 2 CUs could be put in U200 xclbin, and 4 CUs could be put in U250 xclbins.</p>
<p>In the mlp.py, users first need to do the initialization, one fpga_rt is required for one CU, in the following code, model is the Keras Sequential model, its weight matrices are loaded from given model file best_model.h5. xclbin_opts is the paramater loaded from config_info.dat.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fpga_rt</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">fpga_out</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numKernels</span><span class="p">):</span>
  <span class="n">fpga_rt</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mlp_common</span><span class="o">.</span><span class="n">init_fpga</span><span class="p">(</span><span class="n">model</span><span class="p">,</span><span class="n">xclbin_opts</span><span class="p">,</span> <span class="n">g_wgt_scale</span><span class="p">,</span> <span class="n">g_bias_scale</span><span class="p">,</span> <span class="n">g_post_scale</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
<p>After initialization, input sample need to be sent to FPGA for predict, and results will be returned to fpga_out.</p>
<p>For non-async case, simply call predict function will do the job.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numKernels</span><span class="p">):</span>
    <span class="n">fpga_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fpga_rt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">g_in_scale</span><span class="p">))</span>
</pre></div>
</div>
<p>For async case,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numKernels</span><span class="p">):</span>
    <span class="n">fpga_rt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">send_matrices</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="n">xfblas</span><span class="o">.</span><span class="n">executeAsync</span><span class="p">(</span><span class="n">numKernels</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">numKernels</span><span class="p">):</span>
    <span class="n">fpga_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fpga_rt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_result</span><span class="p">())</span>
</pre></div>
</div>
<p>In the given example, the activation function of the last layer is softmax, so CPU softmax function is called after getting the results from FPGA. Users could apply different activation function after getting results from FPGA.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="L3_application.html" class="btn btn-neutral float-left" title="L3 API application" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo" class="copyright">
    <p>
        
        &copy; Copyright 2019, Xilinx Inc.

    </p>
  </div>
<!--
    
    
      Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 
-->
</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>